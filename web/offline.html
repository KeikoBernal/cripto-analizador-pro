<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
</head>
<body class="dashboard-page">
    <aside class="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-chart-line"></i>
            <span>Cripto Pro</span>
        </div>
        
        <nav class="sidebar-nav">
            <div class="nav-section">
                <h4>An치lisis</h4>
                <button class="nav-btn active" onclick="showSection('analisis')">
                    <i class="fas fa-microscope"></i>
                    <span>An치lisis Completo</span>
                </button>
                <button class="nav-btn" onclick="showSection('graficos')">
                    <i class="fas fa-chart-pie"></i>
                    <span>Gr치ficos</span>
                </button>
                <button class="nav-btn" onclick="showSection('datos')">
                    <i class="fas fa-database"></i>
                    <span>Gesti칩n de Datos</span>
                </button>
            </div>
            
            <div class="nav-section">
                <h4>Herramientas</h4>
                <button class="nav-btn" onclick="showSection('simulacion')">
                    <i class="fas fa-flask"></i>
                    <span>Simulaci칩n</span>
                </button>
                <button class="nav-btn" onclick="showSection('correlacion')">
                    <i class="fas fa-project-diagram"></i>
                    <span>Correlaci칩n</span>
                </button>
            </div>
            <div class="nav-section">
                <h4>Educaci칩n</h4>
                <button class="nav-btn" onclick="showSection('sandbox')">
                    <i class="fas fa-graduation-cap"></i>
                    <span>Sandbox Educativo</span>
                </button>
            </div>
            <div class="nav-section">
                <h4>Exportar</h4>
                <button class="nav-btn" onclick="exportResults('csv')">
                    <i class="fas fa-file-csv"></i>
                    <span>Exportar CSV</span>
                </button>
                <button class="nav-btn" onclick="exportResults('pdf')">
                    <i class="fas fa-file-pdf"></i>
                    <span>Exportar PDF</span>
                </button>
            </div>
            
            <div class="nav-section">
                <h4>Backtesting</h4>
                <button class="nav-btn" onclick="showSection('backtesting')">
                    <i class="fas fa-history"></i>
                    <span>Backtesting</span>
                </button>
            </div>
        </nav>
        
        <div class="sidebar-footer">
            <div class="connection-status offline">
                <i class="fas fa-circle"></i>
                <span>Offline</span>
            </div>
            <div class="criptos-count">
                <span id="offline-cripto-count">0</span> criptos cargadas
            </div>
        </div>
    </aside>

    <main class="main-content">
        <header class="content-header">
            <h1>Modo Offline</h1>
            <div class="header-actions">
                <button class="btn-primary" onclick="runFullAnalysis()">
                    <i class="fas fa-play"></i>
                    An치lisis Completo
                </button>
            </div>
        </header>

        <!-- An치lisis Section -->
        <section id="analisis-section" class="content-section active">
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-list-check"></i> Selecci칩n de Criptomonedas</h3>
                </div>
                <div class="cripto-selector" id="cripto-selector" style="max-height: 300px; overflow-y: auto; padding: 1.5rem;">
                    <p class="loading">Cargando criptomonedas disponibles...</p>
                </div>
                <div class="selector-actions" style="padding: 0 1.5rem 1.5rem; display: flex; gap: 1rem;">
                    <button onclick="selectAllCriptos()" class="btn-small">
                        <i class="fas fa-check-square"></i> Seleccionar Todas
                    </button>
                    <button onclick="deselectAllCriptos()" class="btn-small">
                        <i class="fas fa-square"></i> Deseleccionar Todas
                    </button>
                </div>
            </div>

            <div class="panel" id="results-panel" style="display: none;">
                <div class="panel-header">
                    <h3><i class="fas fa-chart-bar"></i> Resultados del An치lisis</h3>
                    <span id="analysis-timestamp"></span>
                </div>
                <div class="table-responsive">
                    <table class="data-table" id="results-table">
                        <thead>
                            <tr>
                                <th>Cripto</th>
                                <th>Precio</th>
                                <th>Tendencia</th>
                                <th>RSI</th>
                                <th>Decisi칩n</th>
                                <th>Confianza</th>
                                <th>Predicci칩n 24h</th>
                            </tr>
                        </thead>
                        <tbody id="results-tbody"></tbody>
                    </table>
                </div>
            </div>
<!-- 游늵 GR츼FICOS PARA SECCI칍N DE AN츼LISIS OFFLINE -->
            <div class="offline-charts-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; max-width: 100%; overflow-x: hidden;">
                <!-- Se침ales de Trading -->
                <div class="offline-chart-card" style="min-width: 0; overflow: hidden;">
                    <div class="chart-header">
                        <h4><i class="fas fa-signal"></i> Se침ales de Trading</h4>
                        <button onclick="actualizarGraficoAnalisis('signals')" class="btn-icon">
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>
                    <div class="chart-container" style="height: 300px; position: relative;">
                        <canvas id="offline-signals-chart"></canvas>
                    </div>
                </div>

                <!-- Confianza por Criptomoneda -->
                <div class="offline-chart-card" style="min-width: 0; overflow: hidden;">
                    <div class="chart-header">
                        <h4><i class="fas fa-chart-bar"></i> Confianza por Criptomoneda</h4>
                        <button onclick="actualizarGraficoAnalisis('confidence')" class="btn-icon">
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>
                    <div class="chart-container" style="height: 300px; position: relative;">
                        <canvas id="offline-confidence-chart"></canvas>
                    </div>
                </div>

                <!-- Volumen por Criptomoneda -->
                <div class="offline-chart-card" style="min-width: 0; overflow: hidden;">
                    <div class="chart-header">
                        <h4><i class="fas fa-coins"></i> Volumen por Criptomoneda</h4>
                        <button onclick="actualizarGraficoAnalisis('volume')" class="btn-icon">
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>
                    <div class="chart-container" style="height: 300px; position: relative;">
                        <canvas id="offline-volume-chart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Gr치ficos Section -->
        <section id="graficos-section" class="content-section">
            <div class="panel">
                <div class="panel-header">
                    <h3>Visualizaci칩n de Datos</h3>
                    <div class="chart-controls" style="display: flex; gap: 0.75rem; align-items: center;">
                        <select id="offline-chart-cripto" onchange="updateOfflineChart()" style="padding: 0.5rem; background: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 6px;">
                            <option value="">Selecciona criptomoneda...</option>
                        </select>
                        <select id="offline-chart-type" onchange="updateOfflineChart()" style="padding: 0.5rem; background: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 6px;">
                            <option value="price">Precio Hist칩rico</option>
                            <option value="candlestick">Velas Japonesas</option>
                            <option value="comparison">Comparaci칩n</option>
                            <option value="tendencias">Tendencias</option>
                            <option value="volumen">Volumen</option>
                            <option value="tecnico">An치lisis T칠cnico</option>
                        </select>
                        <button onclick="updateOfflineChart()" class="btn-icon" style="width: 32px; height: 32px; border-radius: 6px; background: transparent; border: none; color: var(--text-secondary); cursor: pointer;">
                            <i class="fas fa-redo"></i>
                        </button>
                        <button onclick="exportChart('offline-chart')" class="btn-icon" title="Exportar gr치fico">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-container large" style="height: 500px; padding: 1rem;">
                    <canvas id="offline-chart"></canvas>
                </div>
            </div>
        </section>

        <!-- Gesti칩n de Datos Section -->
        <section id="datos-section" class="content-section">
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-upload"></i> Subir Nuevos Datos</h3>
                </div>
                <div class="upload-area" id="upload-area" style="border: 2px dashed var(--border-color); border-radius: 12px; padding: 3rem; text-align: center; margin: 1.5rem; transition: all 0.3s; cursor: pointer;">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">Arrastra archivos CSV aqu칤 o haz clic para seleccionar</p>
                    <input type="file" id="csv-input" accept=".csv" hidden onchange="handleFileSelect(event)">
                    <button onclick="document.getElementById('csv-input').click()" class="btn-secondary">
                        Seleccionar Archivo
                    </button>
                </div>
                <div class="upload-form" id="upload-form" style="display: none; padding: 1.5rem;">
                    <h4>Configurar Criptomoneda</h4>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Nombre de la criptomoneda</label>
                        <input type="text" id="new-cripto-name" placeholder="Ej: Bitcoin" style="width: 100%; padding: 0.625rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); margin-top: 0.5rem;">
                    </div>
                    <div class="preview-data" id="preview-data" style="background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin: 1rem 0; max-height: 200px; overflow: auto;"></div>
                    <div class="form-actions" style="display: flex; gap: 1rem;">
                        <button onclick="confirmUpload()" class="btn-primary">
                            <i class="fas fa-save"></i> Guardar
                        </button>
                        <button onclick="cancelUpload()" class="btn-secondary">Cancelar</button>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-folder-open"></i> Criptomonedas Disponibles</h3>
                </div>
                <div class="criptos-grid" id="criptos-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; padding: 1.5rem;">
                    <!-- Se llena din치micamente -->
                </div>
            </div>
        </section>

        <!-- Backtesting Section -->
        <section id="backtesting-section" class="content-section">
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-history"></i> Backtesting Offline</h3>
                </div>
                <div class="backtesting-form" style="padding: 1.5rem;">
                    <div class="form-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Criptomoneda</label>
                            <select id="backtest-cripto" style="width: 100%; padding: 0.5rem; background: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 6px;">
                                <option value="">Selecciona...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Estrategia</label>
                            <select id="backtest-estrategia" style="width: 100%; padding: 0.5rem; background: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 6px;">
                                <option value="rsi_macd">RSI + MACD</option>
                                <option value="bollinger">Bollinger Bands</option>
                                <option value="golden_cross">Golden Cross (SMA50/200)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Capital Inicial ($)</label>
                            <input type="number" id="backtest-capital" value="10000" min="100" style="width: 100%; padding: 0.5rem; background: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 6px;">
                        </div>
                    </div>
                    <button onclick="runBacktesting()" class="btn-primary">
                        <i class="fas fa-play"></i> Ejecutar Backtesting
                    </button>
                </div>

                <div id="backtest-results" style="display: none; padding: 1.5rem;">
                    <h4>Resultados</h4>
                    <div class="stats-grid" id="backtest-stats"></div>
                    <div class="chart-container" style="height: 400px; margin-top: 1.5rem;">
                        <canvas id="backtest-chart"></canvas>
                    </div>
                    <div class="operations-table" style="margin-top: 1.5rem;">
                        <h5>Operaciones</h5>
                        <div class="table-responsive">
                            <table class="data-table" id="backtest-table">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Tipo</th>
                                        <th>Precio</th>
                                        <th>Ganancia</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Simulaci칩n Section -->
        <section id="simulacion-section" class="content-section">
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-flask"></i> Simulador de Mercado Sint칠tico</h3>
                </div>
                <div class="simulation-form" style="padding: 1.5rem; background: var(--bg-dark); border-radius: 8px; margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">Precio Inicial ($)</label>
                            <input type="number" id="sim-precio" value="50000" step="1000" style="width: 100%; padding: 0.75rem; background: var(--bg-input); border: 1.5px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 1rem;" min="100">
                        </div>
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">D칤as a simular</label>
                            <input type="number" id="sim-dias" value="90" min="30" max="365" style="width: 100%; padding: 0.75rem; background: var(--bg-input); border: 1.5px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 1rem;">
                        </div>
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">Volatilidad (%)</label>
                            <input type="number" id="sim-vol" value="3" min="0.1" max="10" step="0.1" style="width: 100%; padding: 0.75rem; background: var(--bg-input); border: 1.5px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 1rem;">
                        </div>
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">Tendencia diaria (%)</label>
                            <input type="number" id="sim-trend" value="0.1" min="-1" max="1" step="0.01" style="width: 100%; padding: 0.75rem; background: var(--bg-input); border: 1.5px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 1rem;">
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">Nombre del activo simulado</label>
                        <input type="text" id="sim-nombre" value="Simulacion_BTC" placeholder="Nombre 칰nico" style="width: 100%; padding: 0.75rem; background: var(--bg-input); border: 1.5px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 1rem;">
                    </div>
                    <button onclick="runSimulation()" class="btn-primary" id="sim-btn" style="width: 100%; padding: 0.875rem; font-size: 1rem; font-weight: 600;">
                        <i class="fas fa-play"></i> Generar Simulaci칩n
                    </button>
                </div>

                <!-- Barra de progreso -->
                <div id="simulation-progress" style="display: none; padding: 1.5rem; background: var(--bg-dark); border-radius: 8px; margin-top: 1.5rem;">
                    <p style="margin-bottom: 1rem; color: var(--text-primary); font-weight: 500;">Generando simulaci칩n...</p>
                    <div style="background: var(--border-color); height: 8px; border-radius: 4px; overflow: hidden;">
                        <div id="progress-bar" style="background: linear-gradient(90deg, var(--secondary-color), #7c3aed); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 4px;"></div>
                    </div>
                </div>

                <!-- Contenedor de resultados -->
                <div id="simulation-results" style="display: none; padding: 1.5rem; border-top: 2px solid var(--border-color); margin-top: 1.5rem;">
                    <div class="panel-header" style="border: none; padding: 0 0 1.5rem 0;">
                        <h3><i class="fas fa-chart-area"></i> An치lisis de Simulaci칩n Monte Carlo</h3>
                        <button onclick="exportSimulationReport()" class="btn-secondary">
                            <i class="fas fa-download"></i> Exportar Reporte
                        </button>
                    </div>

                    <!-- 游늵 Estad칤sticas Principales -->
                    <div class="stats-grid" id="simulation-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem;"></div>

                    <!-- 游늳 Gr치ficos -->
                    <div class="charts-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <div class="chart-card" style="padding: 1.5rem; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px;">
                            <h4 style="margin-bottom: 1rem; color: var(--text-primary);"><i class="fas fa-chart-line"></i> Trayectoria Simulada</h4>
                            <div class="chart-container" style="height: 350px; position: relative;">
                                <canvas id="simulation-chart-line"></canvas>
                            </div>
                        </div>

                        <div class="chart-card" style="padding: 1.5rem; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px;">
                            <h4 style="margin-bottom: 1rem; color: var(--text-primary);"><i class="fas fa-chart-bar"></i> Histograma de Retornos</h4>
                            <div class="chart-container" style="height: 350px; position: relative;">
                                <canvas id="simulation-histogram"></canvas>
                            </div>
                        </div>

                        <div class="chart-card" style="padding: 1.5rem; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px;">
                            <h4 style="margin-bottom: 1rem; color: var(--text-primary);"><i class="fas fa-chart-area"></i> Bandas de Confianza</h4>
                            <div class="chart-container" style="height: 350px; position: relative;">
                                <canvas id="simulation-bands"></canvas>
                            </div>
                        </div>

                        <div class="chart-card" style="padding: 1.5rem; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px;">
                            <h4 style="margin-bottom: 1rem; color: var(--text-primary);"><i class="fas fa-chart-pie"></i> Drawdown</h4>
                            <div class="chart-container" style="height: 350px; position: relative;">
                                <canvas id="simulation-drawdown"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- 游늶 Tabla de M칠tricas -->
                    <div style="margin-bottom: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                        <h4 style="margin-bottom: 1rem; color: var(--text-primary);"><i class="fas fa-table"></i> M칠tricas Detalladas</h4>
                        <div class="table-responsive">
                            <table class="data-table" id="simulation-metrics-table">
                                <thead>
                                    <tr>
                                        <th>M칠trica</th>
                                        <th>Valor</th>
                                        <th>Interpretaci칩n</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 游 Interpretaci칩n IA -->
                    <div style="margin-top: 1.5rem; padding: 1.5rem; background: var(--bg-dark); border-radius: 8px; border-left: 4px solid var(--secondary-color);">
                        <h4 style="margin-bottom: 1rem; color: var(--secondary-color);"><i class="fas fa-brain"></i> Interpretaci칩n Inteligente</h4>
                            </div>
                        <div class="ia-output" id="simulation-ia-interpretation" style="padding: 1.5rem; background: var(--bg-dark); border-radius: 8px;">
                            <p class="placeholder">Esperando an치lisis...</p>
                        </div>
                    </div>
            </div>
        </section>

        <!-- Correlaci칩n Section -->
        <section id="correlacion-section" class="content-section">
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-project-diagram"></i> An치lisis de Correlaci칩n</h3>
                </div>
                <div class="correlation-selector" style="padding: 1.5rem;">
                    <p>Selecciona al menos 2 criptomonedas para analizar correlaciones:</p>
                    <div class="checkbox-group" id="correlation-checkboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.75rem; margin: 1rem 0;">
                        <!-- Se llena din치micamente -->
                    </div>
                    <button onclick="calculateOfflineCorrelation()" class="btn-primary">
                        <i class="fas fa-calculator"></i> Calcular Matriz
                    </button>
                </div>
                <div id="correlation-results" class="correlation-results" style="display: none; padding: 1.5rem;">
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="correlation-chart"></canvas>
                    </div>
                    <div class="correlation-recommendations" id="correlation-recommendations" style="margin-top: 1.5rem;"></div>
                </div>
            </div>
        </section>

        <!-- Comparaci칩n Section -->
        <section id="comparacion-section" class="content-section">
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-balance-scale"></i> Comparaci칩n M칰ltiple</h3>
                </div>
                <div class="comparison-config" style="padding: 1.5rem;">
                    <div class="form-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>M칠trica a comparar</label>
                            <select id="comparison-metric" style="width: 100%; padding: 0.5rem; background: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 6px;">
                                <option value="precio">Precio Actual</option>
                                <option value="cambio">Cambio 24h</option>
                                <option value="volumen">Volumen</option>
                                <option value="rsi">RSI</option>
                                <option value="macd">MACD</option>
                                <option value="volatilidad">Volatilidad</option>
                                <option value="confianza">Confianza</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tipo de gr치fico</label>
                            <select id="comparison-chart-type" style="width: 100%; padding: 0.5rem; background: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 6px;">
                                <option value="barras">Barras</option>
                                <option value="lineas">L칤neas</option>
                                <option value="radar">Radar</option>
                                <option value="heatmap">Heatmap</option>
                            </select>
                        </div>
                    </div>
                    <div class="checkbox-group" id="comparison-checkboxes" style="margin: 1rem 0;">
                        <!-- Se llena din치micamente -->
                    </div>
                    <button onclick="runComparison()" class="btn-primary">
                        <i class="fas fa-chart-bar"></i> Generar Comparaci칩n
                    </button>
                </div>
                <div id="comparison-results" style="display: none; padding: 1.5rem;">
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="comparison-chart"></canvas>
                    </div>
                    <div id="comparison-table" style="margin-top: 1.5rem;">
                        <h5>Tabla de Comparaci칩n</h5>
                        <div class="table-responsive">
                            <table class="data-table" id="comparison-data-table">
                                <thead id="comparison-thead"></thead>
                                <tbody id="comparison-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- Sandbox Educativo -->
        <section id="sandbox-section" class="content-section">
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-graduation-cap"></i> Sandbox Educativo</h3>
                    <p>Aprende los conceptos clave del trading de forma interactiva y visual.</p>
                </div>
                <div class="sandbox-intro">
                    <p>Bienvenido al 치rea de aprendizaje. Selecciona un tema para comenzar:</p>
                </div>
                <div class="indicators-grid" id="sandbox-topics">
                    <!-- Se llenar치 din치micamente -->
                </div>
                <div id="sandbox-content" class="indicator-detail" style="display: none;">
                    <!-- Contenido din치mico del tema seleccionado -->
                </div>
            </div>
            <!-- Minijuego: 쮺omprar o Esperar? -->
                <div id="fomo-game-section" style="margin-top: 2rem; display: flex; justify-content: center;">
                    <div class="panel" style="background: linear-gradient(135deg, rgba(159, 27, 127, 0.15), rgba(255, 197, 0, 0.1)); border: 2px solid rgba(255, 197, 0, 0.3); width: 100%; max-width: 900px;">
                        <div class="panel-header">
                            <h3><i class="fas fa-gamepad"></i> Minijuego: 쮺omprar o Esperar?</h3>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">Practica tu disciplina emocional con datos reales de tus criptomonedas</p>
                        </div>

                        <div id="fomo-game-container" style="padding: 1.5rem;">
                            <!-- Secci칩n de inicio (mostrada por defecto) -->
                            <div id="fomo-setup-section">
                                <!-- Selector de criptomoneda -->
                                <div style="margin-bottom: 2rem;">
                                    <label style="display: block; margin-bottom: 0.75rem; color: var(--text-primary); font-weight: 600;">Selecciona una criptomoneda:</label>
                                    <select id="fomo-cripto-select" style="width: 100%; padding: 0.75rem; background: var(--bg-dark); border: 1.5px solid var(--border-color); color: var(--text-primary); border-radius: 8px; font-size: 1rem;">
                                        <option value="">-- Elige una criptomoneda --</option>
                                    </select>
                                </div>

                                <!-- Bot칩n para iniciar juego -->
                                <button onclick="startFomoGame()" class="btn-primary" id="start-fomo-btn" style="width: 100%; padding: 1rem; font-size: 1.1rem; margin-bottom: 2rem;">
                                    <i class="fas fa-play"></i> Iniciar Minijuego
                                </button>
                            </div>

                            <!-- 츼rea de juego (oculta inicialmente) -->
                            <div id="fomo-game-play" style="display: none;">
                                <!-- Gr치fico hist칩rico -->
                                <div style="margin-bottom: 2rem; background: rgba(26, 31, 58, 0.5); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(255, 197, 0, 0.2);">
                                    <h4 style="margin-bottom: 1rem; color: var(--text-primary);">Gr치fico hasta el momento de decisi칩n:</h4>
                                    <div style="height: 300px;">
                                        <canvas id="fomo-game-chart"></canvas>
                                    </div>
                                </div>

                                <!-- Informaci칩n del momento -->
                                <div style="background: rgba(255, 197, 0, 0.1); border: 1.5px solid var(--secondary-color); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                                    <h4 style="color: var(--secondary-color); margin-bottom: 1rem;">
                                        <i class="fas fa-exclamation-circle"></i> Momento Cr칤tico
                                    </h4>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                                        <div>
                                            <p style="color: var(--text-secondary); font-size: 0.85rem;">Precio Actual</p>
                                            <p style="font-size: 1.5rem; font-weight: 700; color: var(--secondary-color);" id="fomo-current-price">$0</p>
                                        </div>
                                        <div>
                                            <p style="color: var(--text-secondary); font-size: 0.85rem;">Cambio en 칰ltima hora</p>
                                            <p style="font-size: 1.5rem; font-weight: 700; color: #00ff88;" id="fomo-price-change">+0%</p>
                                        </div>
                                        <div>
                                            <p style="color: var(--text-secondary); font-size: 0.85rem;">Tiempo para decidir</p>
                                            <p style="font-size: 1.5rem; font-weight: 700; color: #ff6b6b;" id="fomo-countdown">10s</p>
                                        </div>
                                    </div>
                                    <p style="color: var(--text-primary); line-height: 1.6;">
                                        <i class="fas fa-chart-line"></i> El precio est치 subiendo r치pidamente. 
                                        <strong>쮼ntras en p치nico (FOMO) y compras, o esperas a una correcci칩n?</strong>
                                    </p>
                                </div>

                                <!-- Botones de decisi칩n -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                                    <button onclick="makeDecision(true)" class="btn-danger" id="buy-btn" style="padding: 1.5rem; font-size: 1.1rem; min-height: 80px;">
                                        <i class="fas fa-shopping-cart" style="font-size: 1.5rem; display: block; margin-bottom: 0.5rem;"></i>
                                        춰COMPRAR AHORA!
                                    </button>
                                    <button onclick="makeDecision(false)" class="btn-success" id="wait-btn" style="padding: 1.5rem; font-size: 1.1rem; min-height: 80px;">
                                        <i class="fas fa-pause" style="font-size: 1.5rem; display: block; margin-bottom: 0.5rem;"></i>
                                        ESPERAR Y OBSERVAR
                                    </button>
                                </div>
                            </div>

                            <!-- Resultados (oculto inicialmente) -->
                            <div id="fomo-results" style="display: none;">
                                <div id="fomo-results-content" style="background: rgba(26, 31, 58, 0.5); padding: 2rem; border-radius: 12px; border-left: 4px solid var(--secondary-color);">
                                    <!-- Se llenar치 din치micamente -->
                                </div>
                                <button onclick="resetFomoGame()" class="btn-primary" style="width: 100%; padding: 1rem; margin-top: 2rem;">
                                    <i class="fas fa-redo"></i> Jugar de Nuevo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
        </section>
    </main>

    <button class="fab-mode-switch" onclick="switchMode()" title="Cambiar a Modo Online">
        <i class="fas fa-exchange-alt"></i>
        <span>Cambiar Modo</span>
    </button>

    <script src="script.js"></script>
    <script>
        let currentResults = [];
        let availableCriptos = ['ADA', 'BNB', 'BTC', 'DOGE', 'DOT', 'ETH', 'SOL', 'XRP', 'USDT'];
        let uploadFile = null;
        let charts = {};
        window.charts = window.charts || {};

        document.addEventListener('DOMContentLoaded', () => {
            loadAvailableCriptos();
            setupDragAndDrop();
            // Inicializar minijuego si el script est치 disponible
            if (typeof loadHistoricalDataForGame === 'function') {
                setTimeout(() => loadHistoricalDataForGame(), 500);
            }
        });

        function loadAvailableCriptos() {
            fetch('/api/offline/criptos')
                .then(r => r.json())
                .then(data => {
                    availableCriptos = data.criptos;
                    document.getElementById('offline-cripto-count').textContent = data.count;
                    renderCriptoSelector();
                    if (typeof initializeFomoSelector === 'function') {
                        initializeFomoSelector();
                    }
                    renderCriptosGrid();
                    updateChartSelector();
                    updateCorrelationCheckboxes();
                    updateBacktestSelector();
                });
        }

        function renderCriptoSelector() {
            const container = document.getElementById('cripto-selector');
            if(availableCriptos.length === 0) {
                container.innerHTML = '<p class="empty" style="text-align: center; color: var(--text-secondary); padding: 2rem;">No hay criptomonedas disponibles. Sube archivos CSV primero.</p>';
                return;
            }
            
            container.innerHTML = availableCriptos.map(c => `
                <label class="cripto-checkbox" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                    <input type="checkbox" value="${c}" checked style="width: 18px; height: 18px;">
                    <span class="checkmark"></span>
                    <span class="name">${c}</span>
                </label>
            `).join('');
        }

        function renderCriptosGrid() {
            const grid = document.getElementById('criptos-grid');
            grid.innerHTML = availableCriptos.map(c => `
                <div class="cripto-item" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 8px;">
                    <i class="fas fa-coins" style="color: var(--primary-color);"></i>
                    <span style="flex: 1;">${c}</span>
                    <button onclick="deleteCripto('${c}')" class="btn-icon" title="Eliminar" style="width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; background: transparent; border: none; color: var(--text-secondary); cursor: pointer;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        function updateChartSelector() {
            const select = document.getElementById('offline-chart-cripto');
            select.innerHTML = '<option value="">Selecciona criptomoneda...</option>' +
                availableCriptos.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function updateCorrelationCheckboxes() {
            const container = document.getElementById('correlation-checkboxes');
            container.innerHTML = availableCriptos.map(c => `
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: var(--bg-dark); border-radius: 6px; cursor: pointer;">
                    <input type="checkbox" value="${c}" style="width: 18px; height: 18px;">
                    <span>${c}</span>
                </label>
            `).join('');
        }

        function updateBacktestSelector() {
            const select = document.getElementById('backtest-cripto');
            select.innerHTML = '<option value="">Selecciona...</option>' +
                availableCriptos.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function updateComparisonCheckboxes() {
            const container = document.getElementById('comparison-checkboxes');
            container.innerHTML = availableCriptos.map(c => `
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: var(--bg-dark); border-radius: 6px; cursor: pointer;">
                    <input type="checkbox" value="${c}" checked style="width: 18px; height: 18px;">
                    <span>${c}</span>
                </label>
            `).join('');
        }

        function selectAllCriptos() {
            document.querySelectorAll('#cripto-selector input').forEach(cb => cb.checked = true);
        }

        function deselectAllCriptos() {
            document.querySelectorAll('#cripto-selector input').forEach(cb => cb.checked = false);
        }

        function runFullAnalysis() {
            const selected = Array.from(document.querySelectorAll('#cripto-selector input:checked'))
                .map(cb => cb.value);
            
            if(selected.length === 0) {
                alert('Selecciona al menos una criptomoneda');
                return;
            }

            const btn = document.querySelector('.btn-primary[onclick="runFullAnalysis()"]');
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Analizando...';
            btn.disabled = true;

            fetch('/api/offline/analisis', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({criptos: selected})
            })
            .then(r => r.json())
            .then(data => {
                currentResults = data.resultados;
                displayResults(data.resultados);
                document.getElementById('results-panel').style.display = 'block';
                document.getElementById('analysis-timestamp').textContent = 
                    'An치lisis realizado: ' + new Date().toLocaleString();
                
                btn.innerHTML = '<i class="fas fa-play"></i> An치lisis Completo';
                btn.disabled = false;
            });
        }

        function displayResults(resultados) {
            console.log("游늵 Mostrando resultados offline:", resultados);
            
            // Guardar resultados globalmente para los gr치ficos
            window.currentOfflineResults = resultados;
            
            const tbody = document.getElementById('results-tbody');
            
            const signals = { compra: 0, venta: 0, mantener: 0 };
            let tableHTML = '';
            
            resultados.forEach(r => {
                if(!r.success) return;
                
                const decisionClass = r.decision_info.decision.includes('COMPRAR') ? 'buy' : 
                                    r.decision_info.decision.includes('VENDER') ? 'sell' : 'hold';
                
                if (r.decision_info.decision.includes('COMPRAR')) signals.compra++;
                else if (r.decision_info.decision.includes('VENDER')) signals.venta++;
                else signals.mantener++;
                
                tableHTML += `
                    <tr>
                        <td><strong>${r.cripto}</strong></td>
                        <td>$${r.precio_actual.toLocaleString()}</td>
                        <td><span class="trend ${r.tendencia.toLowerCase()}">${r.tendencia}</span></td>
                        <td>${r.indicadores?.rsi?.toFixed(1) || '--'}</td>
                        <td><span class="signal ${decisionClass}">${r.decision_info.decision}</span></td>
                        <td>${(r.decision_info.confianza * 100).toFixed(0)}%</td>
                        <td>$${r.prediccion.prediccion_final.toLocaleString()} (${r.prediccion.cambio_porcentual > 0 ? '+' : ''}${r.prediccion.cambio_porcentual.toFixed(1)}%)</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = tableHTML;
            
            // Mostrar resultados en gr치ficos
            actualizarGraficosOfflineConDatos(resultados);
            
            document.getElementById('results-panel').style.display = 'block';
            document.getElementById('analysis-timestamp').textContent = 
                'An치lisis realizado: ' + new Date().toLocaleString();
        }

        function updateOfflineChart() {
            const cripto = document.getElementById('offline-chart-cripto').value;
            const type = document.getElementById('offline-chart-type').value;
            
            if(!cripto) return;
            
            fetch(`/api/offline/datos-historicos/${cripto}`)
                .then(r => r.json())
                .then(data => {
                    if(data.error) {
                        alert('Error: ' + data.error);
                        return;
                    }
                    
                    const ctx = document.getElementById('offline-chart').getContext('2d');
                    
                    if(charts.offline) {
                        charts.offline.destroy();
                    }
                    
                    let datasets = [];
                    let chartType = 'line';
                    
                    if(type === 'price') {
                        datasets = [{
                            label: 'Precio de Cierre',
                            data: data.precios,
                            borderColor: '#2196F3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            fill: true,
                            tension: 0.1
                        }, {
                            label: 'SMA 20',
                            data: calculateSMA(data.precios, 20),
                            borderColor: '#FF9800',
                            borderDash: [5, 5],
                            fill: false
                        }];
                    } else if(type === 'candlestick') {
                        // Velas japonesas reales
                        const candleData = data.fechas.map((fecha, i) => ({
                            x: fecha,
                            o: data.open[i],
                            h: data.high[i],
                            l: data.low[i],
                            c: data.precios[i]
                        }));
                        
                        datasets = [{
                            label: 'Velas Japonesas',
                            data: candleData,
                            borderColor: '#2196F3',
                            backgroundColor: function(ctx) {
                                const candle = ctx.raw;
                                return candle.c >= candle.o ? 'rgba(76, 175, 80, 0.8)' : 'rgba(244, 67, 54, 0.8)';
                            },
                            borderWidth: 1
                        }];
                        chartType = 'candlestick';
                    } else if(type === 'volumen') {
                        chartType = 'bar';
                        datasets = [{
                            label: 'Volumen',
                            data: data.volumenes,
                            backgroundColor: 'rgba(33, 150, 243, 0.5)'
                        }];
                    } else if(type === 'tecnico') {
                        const rsiValues = calculateRSI(data.precios);
                        datasets = [{
                            label: 'RSI',
                            data: rsiValues,
                            borderColor: '#9C27B0',
                            fill: false
                        }, {
                            label: 'Sobrecompra (70)',
                            data: new Array(rsiValues.length).fill(70),
                            borderColor: '#F44336',
                            borderDash: [5, 5],
                            pointRadius: 0
                        }, {
                            label: 'Sobreventa (30)',
                            data: new Array(rsiValues.length).fill(30),
                            borderColor: '#4CAF50',
                            borderDash: [5, 5],
                            pointRadius: 0
                        }];
                    }
                    
                    charts.offline = new Chart(ctx, {
                        type: chartType,
                        data: {
                            labels: data.fechas,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    ticks: {
                                        callback: value => type === 'price' || type === 'candlestick' ? '$' + value.toLocaleString() : value
                                    }
                                }
                            }
                        }
                    });
                });
        }

        function calculateSMA(data, period) {
            const sma = [];
            for(let i = 0; i < data.length; i++) {
                if(i < period - 1) {
                    sma.push(null);
                } else {
                    const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
                    sma.push(sum / period);
                }
            }
            return sma;
        }

        function calculateRSI(prices, period = 14) {
            const rsi = [];
            for(let i = 0; i < prices.length; i++) {
                if(i < period) {
                    rsi.push(50);
                } else {
                    let gains = 0, losses = 0;
                    for(let j = i - period + 1; j <= i; j++) {
                        const change = prices[j] - prices[j-1];
                        if(change > 0) gains += change;
                        else losses += Math.abs(change);
                    }
                    const avgGain = gains / period;
                    const avgLoss = losses / period;
                    const rs = avgGain / (avgLoss || 1);
                    rsi.push(100 - (100 / (1 + rs)));
                }
            }
            return rsi;
        }

        function runBacktesting() {
            const cripto = document.getElementById('backtest-cripto').value;
            const estrategia = document.getElementById('backtest-estrategia').value;
            const capital = parseFloat(document.getElementById('backtest-capital').value);

            if (!cripto) {
                alert('Selecciona una criptomoneda');
                return;
            }

            fetch('/api/offline/backtesting', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({cripto, estrategia, capital})
            })
            .then(r => r.json())
            .then(data => {
                if(data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                document.getElementById('backtest-results').style.display = 'block';

                // Estad칤sticas
                document.getElementById('backtest-stats').innerHTML = `
                    <div class="stat-box" style="background: var(--bg-card); padding: 1rem; border-radius: 8px; text-align: center;">
                        <span class="label" style="display: block; color: var(--text-secondary); font-size: 0.875rem;">Capital Inicial</span>
                        <span class="value" style="display: block; font-size: 1.25rem; font-weight: 600; margin-top: 0.25rem;">$${data.capital_inicial.toLocaleString()}</span>
                    </div>
                    <div class="stat-box" style="background: var(--bg-card); padding: 1rem; border-radius: 8px; text-align: center;">
                        <span class="label" style="display: block; color: var(--text-secondary); font-size: 0.875rem;">Capital Final</span>
                        <span class="value" style="display: block; font-size: 1.25rem; font-weight: 600; margin-top: 0.25rem;">$${data.capital_final.toLocaleString()}</span>
                    </div>
                    <div class="stat-box" style="background: var(--bg-card); padding: 1rem; border-radius: 8px; text-align: center;">
                        <span class="label" style="display: block; color: var(--text-secondary); font-size: 0.875rem;">Retorno Estrategia</span>
                        <span class="value" style="display: block; font-size: 1.25rem; font-weight: 600; margin-top: 0.25rem; color: ${data.retorno_total > 0 ? '#4CAF50' : '#F44336'};">${data.retorno_total.toFixed(2)}%</span>
                    </div>
                    <div class="stat-box" style="background: var(--bg-card); padding: 1rem; border-radius: 8px; text-align: center;">
                        <span class="label" style="display: block; color: var(--text-secondary); font-size: 0.875rem;">Buy & Hold</span>
                        <span class="value" style="display: block; font-size: 1.25rem; font-weight: 600; margin-top: 0.25rem; color: ${data.buy_and_hold > 0 ? '#4CAF50' : '#F44336'};">${data.buy_and_hold.toFixed(2)}%</span>
                    </div>
                    <div class="stat-box" style="background: var(--bg-card); padding: 1rem; border-radius: 8px; text-align: center;">
                        <span class="label" style="display: block; color: var(--text-secondary); font-size: 0.875rem;">Max Drawdown</span>
                        <span class="value" style="display: block; font-size: 1.25rem; font-weight: 600; margin-top: 0.25rem; color: #F44336;">${data.max_drawdown.toFixed(2)}%</span>
                    </div>
                    <div class="stat-box" style="background: var(--bg-card); padding: 1rem; border-radius: 8px; text-align: center;">
                        <span class="label" style="display: block; color: var(--text-secondary); font-size: 0.875rem;">Operaciones</span>
                        <span class="value" style="display: block; font-size: 1.25rem; font-weight: 600; margin-top: 0.25rem;">${data.cantidad_operaciones}</span>
                    </div>
                `;

                // Tabla de operaciones
                const tbody = document.querySelector('#backtest-table tbody');
                tbody.innerHTML = '';
                data.operaciones.forEach(op => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${new Date(op.fecha).toLocaleDateString()}</td>
                        <td><span class="signal ${op.tipo === 'COMPRA' ? 'buy' : 'sell'}">${op.tipo}</span></td>
                        <td>$${op.precio.toLocaleString()}</td>
                        <td>${op.ganancia !== undefined ? (op.ganancia > 0 ? '+' : '') + (op.ganancia * 100).toFixed(2) + '%' : '-'}</td>
                    `;
                });

                // Gr치fico de capital
                const ctx = document.getElementById('backtest-chart').getContext('2d');
                if (charts.backtest) charts.backtest.destroy();

                const capitalData = [];
                let currentCapital = data.capital_inicial;
                
                data.operaciones.forEach((op, i) => {
                    if (op.ganancia !== undefined) {
                        currentCapital *= (1 + op.ganancia);
                    }
                    capitalData.push(currentCapital);
                });

                charts.backtest = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.operaciones.map(op => new Date(op.fecha).toLocaleDateString()),
                        datasets: [{
                            label: 'Capital con Estrategia',
                            data: capitalData,
                            borderColor: '#2196F3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            fill: true,
                            tension: 0.1
                        }, {
                            label: 'Buy & Hold',
                            data: new Array(capitalData.length).fill(data.capital_inicial * (1 + data.buy_and_hold / 100)),
                            borderColor: '#9E9E9E',
                            borderDash: [5, 5],
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                ticks: {
                                    callback: value => '$' + value.toLocaleString()
                                }
                            }
                        }
                    }
                });
            });
        }

        function runSimulation() {
            const btn = document.getElementById('sim-btn');
            const progressDiv = document.getElementById('simulation-progress');
            const resultsDiv = document.getElementById('simulation-results');
            const progressBar = document.getElementById('progress-bar');
            
            const params = {
                precio_inicial: parseFloat(document.getElementById('sim-precio').value),
                dias: parseInt(document.getElementById('sim-dias').value),
                volatilidad: parseFloat(document.getElementById('sim-vol').value) / 100,
                tendencia: parseFloat(document.getElementById('sim-trend').value) / 100,
                nombre: document.getElementById('sim-nombre').value
            };

            // Mostrar progreso
            btn.style.display = 'none';
            progressDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            
            // Simular progreso
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 10;
                progressBar.style.width = progress + '%';
                if(progress >= 90) clearInterval(progressInterval);
            }, 200);

            fetch('/api/offline/simulacion', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(params)
            })
            .then(r => r.json())
            .then(data => {
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                    btn.style.display = 'inline-flex';
                    
                    if(data.success) {
                        displaySimulationResults(data);
                        resultsDiv.style.display = 'block';
                        loadAvailableCriptos(); // Recargar lista
                    }
                }, 500);
            })
            .catch(err => {
                clearInterval(progressInterval);
                progressDiv.style.display = 'none';
                btn.style.display = 'inline-flex';
                alert('Error en la simulaci칩n: ' + err.message);
            });
        }

        function displaySimulationResults(data) {
            const ctx = document.getElementById('simulation-chart').getContext('2d');
            
            if(charts.simulation) {
                charts.simulation.destroy();
            }
            
            charts.simulation = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.datos.fechas,
                    datasets: [{
                        label: 'Precio Simulado',
                        data: data.datos.precios,
                        borderColor: '#2196F3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            ticks: {
                                callback: value => '$' + value.toLocaleString()
                            }
                        }
                    }
                }
            });

            const precios = data.datos.precios;
            const stats = {
                inicial: precios[0],
                final: precios[precios.length - 1],
                min: Math.min(...precios),
                max: Math.max(...precios),
                cambio: ((precios[precios.length - 1] - precios[0]) / precios[0] * 100).toFixed(2)
            };

            document.getElementById('simulation-stats').innerHTML = `
                <div class="stat-box" style="background: linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(33, 150, 243, 0.05)); padding: 1.5rem; border-radius: 12px; text-align: center; border: 1px solid rgba(33, 150, 243, 0.3); backdrop-filter: blur(10px);">
                    <span class="label" style="display: block; color: var(--text-secondary); font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem;">游눳 Precio Inicial</span>
                    <span class="value" style="display: block; font-size: 1.75rem; font-weight: 800; color: #2196F3; font-family: 'Courier New', monospace;">$${stats.inicial.toLocaleString('es-ES', {maximumFractionDigits: 2})}</span>
                </div>
                <div class="stat-box" style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(76, 175, 80, 0.05)); padding: 1.5rem; border-radius: 12px; text-align: center; border: 1px solid rgba(76, 175, 80, 0.3); backdrop-filter: blur(10px);">
                    <span class="label" style="display: block; color: var(--text-secondary); font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem;">游꿢 Precio Final</span>
                    <span class="value" style="display: block; font-size: 1.75rem; font-weight: 800; color: #4CAF50; font-family: 'Courier New', monospace;">$${stats.final.toLocaleString('es-ES', {maximumFractionDigits: 2})}</span>
                </div>
                <div class="stat-box" style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(76, 175, 80, 0.05)); padding: 1.5rem; border-radius: 12px; text-align: center; border: 1px solid rgba(76, 175, 80, 0.3); backdrop-filter: blur(10px);">
                    <span class="label" style="display: block; color: var(--text-secondary); font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem;">游늳 M치ximo</span>
                    <span class="value" style="display: block; font-size: 1.75rem; font-weight: 800; color: #00C853; font-family: 'Courier New', monospace;">$${stats.max.toLocaleString('es-ES', {maximumFractionDigits: 2})}</span>
                </div>
                <div class="stat-box" style="background: linear-gradient(135deg, rgba(244, 67, 54, 0.2), rgba(244, 67, 54, 0.05)); padding: 1.5rem; border-radius: 12px; text-align: center; border: 1px solid rgba(244, 67, 54, 0.3); backdrop-filter: blur(10px);">
                    <span class="label" style="display: block; color: var(--text-secondary); font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem;">游늴 M칤nimo</span>
                    <span class="value" style="display: block; font-size: 1.75rem; font-weight: 800; color: #F44336; font-family: 'Courier New', monospace;">$${stats.min.toLocaleString('es-ES', {maximumFractionDigits: 2})}</span>
                </div>
                <div class="stat-box" style="background: linear-gradient(135deg, ${stats.cambio > 0 ? 'rgba(76, 175, 80, 0.2), rgba(76, 175, 80, 0.05)' : 'rgba(244, 67, 54, 0.2), rgba(244, 67, 54, 0.05)'}); padding: 1.5rem; border-radius: 12px; text-align: center; border: 1px solid ${stats.cambio > 0 ? 'rgba(76, 175, 80, 0.3)' : 'rgba(244, 67, 54, 0.3)'}; backdrop-filter: blur(10px);">
                    <span class="label" style="display: block; color: var(--text-secondary); font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem;">游눷 Cambio Total</span>
                    <span class="value" style="display: block; font-size: 1.75rem; font-weight: 800; color: ${stats.cambio > 0 ? '#4CAF50' : '#F44336'}; font-family: 'Courier New', monospace;">${stats.cambio > 0 ? ' +' : ' '}${Math.abs(stats.cambio).toFixed(2)}%</span>
                </div>
            `;
        }

        function calculateOfflineCorrelation() {
            const checkboxes = document.querySelectorAll('#correlation-checkboxes input:checked');
            const selected = Array.from(checkboxes).map(cb => cb.value);
            
            if(selected.length < 2) {
                alert('Selecciona al menos 2 criptomonedas');
                return;
            }

            fetch('/api/offline/correlacion', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({criptos: selected})
            })
            .then(r => r.json())
            .then(data => {
                if(data.error) {
                    alert(data.error);
                    return;
                }
                
                document.getElementById('correlation-results').style.display = 'block';
                
                const ctx = document.getElementById('correlation-chart').getContext('2d');
                
                if(charts.correlation) {
                    charts.correlation.destroy();
                }
                
                // Crear matriz de calor
                const labels = data.matriz_correlacion.labels;
                const valores = data.matriz_correlacion.valores;
                
                charts.correlation = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: labels.map((label, i) => ({
                            label: label,
                            data: valores[i],
                            backgroundColor: valores[i].map(v => {
                                if(v > 0.8) return '#F44336';
                                if(v > 0.5) return '#FF9800';
                                if(v > 0) return '#4CAF50';
                                return '#2196F3';
                            })
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => `${ctx.dataset.label} vs ${labels[ctx.dataIndex]}: ${ctx.raw.toFixed(2)}`
                                }
                            }
                        },
                        scales: {
                            x: { stacked: true },
                            y: { 
                                stacked: true,
                                min: -1,
                                max: 1
                            }
                        }
                    }
                });
                
                // Mostrar recomendaciones
                const recsDiv = document.getElementById('correlation-recommendations');
                recsDiv.innerHTML = `
                    <h4 style="margin-bottom: 1rem;">Recomendaciones de Diversificaci칩n</h4>
                    <div style="display: grid; gap: 0.75rem;">
                        ${data.recomendaciones.map(r => `
                            <div style="background: var(--bg-dark); padding: 1rem; border-radius: 8px; border-left: 4px solid ${r.correlacion > 0.7 ? '#F44336' : '#4CAF50'};">
                                <strong>${r.par}</strong> - ${r.tipo}<br>
                                <small style="color: var(--text-secondary);">${r.mensaje}</small><br>
                                <small style="color: var(--primary-color);">游눠 ${r.estrategia}</small>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${data.clusters.length > 0 ? `
                        <h4 style="margin: 1.5rem 0 1rem;">Grupos Identificados (Clusters)</h4>
                        <div style="display: grid; gap: 0.75rem;">
                            ${data.clusters.map(c => `
                                <div style="background: var(--bg-dark); padding: 1rem; border-radius: 8px;">
                                    <strong>Grupo ${c.id}:</strong> ${c.criptomonedas.join(', ')}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="correlation-stats-card" style="margin-top: 1.5rem;">
                        <div class="panel">
                            <div class="panel-header">
                                <h4><i class="fas fa-calculator"></i> Estad칤sticas Globales</h4>
                            </div>
                            <div class="correlation-stats-content" style="padding: 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div class="stat-card-mini">
                                    <div class="label">Correlaci칩n Promedio</div>
                                    <div class="value">${data.estadisticas.correlacion_promedio.toFixed(2)}</div>
                                </div>
                                <div class="stat-card-mini">
                                    <div class="label">Correlaci칩n M치xima</div>
                                    <div class="value">${data.estadisticas.max_correlacion.toFixed(2)}</div>
                                </div>
                                <div class="stat-card-mini">
                                    <div class="label">Correlaci칩n M칤nima</div>
                                    <div class="value">${data.estadisticas.min_correlacion.toFixed(2)}</div>
                                </div>
                                <div class="stat-card-mini">
                                    <div class="label">D칤as Analizados</div>
                                    <div class="value">${data.periodo_analisis}</div>
                                </div>
                            </div>
                        </div>
                `;
            });
        }

        function runComparison() {
            const checkboxes = document.querySelectorAll('#comparison-checkboxes input:checked');
            const selected = Array.from(checkboxes).map(cb => cb.value);
            const metric = document.getElementById('comparison-metric').value;
            const chartType = document.getElementById('comparison-chart-type').value;

            if(selected.length < 2) {
                alert('Selecciona al menos 2 criptomonedas');
                return;
            }

            fetch('/api/offline/comparacion', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({criptos: selected, metrica: metric})
            })
            .then(r => r.json())
            .then(data => {
                if(data.error) {
                    alert(data.error);
                    return;
                }

                document.getElementById('comparison-results').style.display = 'block';

                // Actualizar gr치fico de comparaci칩n
                const ctx = document.getElementById('comparison-chart').getContext('2d');
                if(charts.comparison) charts.comparison.destroy();

                const labels = data.resultados.map(r => r.cripto);
                const values = data.resultados.map(r => r.valor);

                let chartConfig = {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: data.metrica,
                            data: values,
                            backgroundColor: values.map((v, i) => [
                                'rgba(33, 150, 243, 0.8)',
                                'rgba(76, 175, 80, 0.8)',
                                'rgba(244, 67, 54, 0.8)',
                                'rgba(255, 193, 7, 0.8)',
                                'rgba(156, 39, 176, 0.8)',
                                'rgba(0, 188, 212, 0.8)'
                            ][i % 6]),
                            borderColor: values.map((v, i) => [
                                '#2196F3',
                                '#4CAF50',
                                '#F44336',
                                '#FFC107',
                                '#9C27B0',
                                '#00BCD4'
                            ][i % 6]),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                };

                if(chartType === 'radar') {
                    chartConfig.type = 'radar';
                    chartConfig.options.scales = {
                        r: {
                            beginAtZero: true
                        }
                    };
                } else if(chartType === 'heatmap') {
                    // Implementar heatmap si es necesario
                    chartConfig.type = 'bar';
                }

                charts.comparison = new Chart(ctx, chartConfig);

                // Actualizar tabla de comparaci칩n
                const thead = document.getElementById('comparison-thead');
                const tbody = document.getElementById('comparison-tbody');
                
                thead.innerHTML = `
                    <tr>
                        <th>Criptomoneda</th>
                        <th>${data.metrica}</th>
                        <th>Posici칩n</th>
                    </tr>
                `;

                tbody.innerHTML = data.resultados.map((r, i) => `
                    <tr>
                        <td><strong>${r.cripto}</strong></td>
                        <td>${formatValue(r.valor, data.metrica)}</td>
                        <td>#${i + 1}</td>
                    </tr>
                `).join('');
            });
        }

        function formatValue(value, metric) {
            switch(metric) {
                case 'precio':
                case 'volumen':
                    return '$' + value.toLocaleString();
                case 'cambio':
                case 'volatilidad':
                case 'confianza':
                    return value.toFixed(2) + '%';
                case 'rsi':
                case 'macd':
                    return value.toFixed(2);
                default:
                    return value;
            }
        }

        function setupDragAndDrop() {
            const uploadArea = document.getElementById('upload-area');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.style.borderColor = 'var(--primary-color)';
                    uploadArea.style.background = 'rgba(33, 150, 243, 0.05)';
                });
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.style.borderColor = 'var(--border-color)';
                    uploadArea.style.background = 'transparent';
                });
            });

            uploadArea.addEventListener('drop', handleDrop);
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if(files.length) handleFile(files[0]);
        }

        function handleFileSelect(e) {
            if(e.target.files.length) handleFile(e.target.files[0]);
        }

        function handleFile(file) {
            if(!file.name.endsWith('.csv')) {
                alert('Solo se permiten archivos CSV');
                return;
            }
            uploadFile = file;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const lines = text.split('\n').slice(0, 6);
                document.getElementById('preview-data').innerHTML = 
                    '<pre style="font-size: 0.75rem; color: var(--text-secondary);">' + lines.join('\n') + '</pre>';
            };
            reader.readAsText(file);
            
            document.getElementById('upload-form').style.display = 'block';
            document.getElementById('upload-area').style.display = 'none';
        }

        function confirmUpload() {
            const nombre = document.getElementById('new-cripto-name').value.trim();
            if(!nombre) {
                alert('Ingresa un nombre para la criptomoneda');
                return;
            }

            const formData = new FormData();
            formData.append('file', uploadFile);
            formData.append('nombre', nombre);

            fetch('/api/offline/subir-csv', {
                method: 'POST',
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                if(data.success) {
                    alert(`九 ${data.message}`);
                    cancelUpload();
                    loadAvailableCriptos();
                } else {
                    alert('仇 ' + data.error);
                }
            });
        }

        function cancelUpload() {
            uploadFile = null;
            document.getElementById('upload-form').style.display = 'none';
            document.getElementById('upload-area').style.display = 'block';
            document.getElementById('csv-input').value = '';
        }

        function exportResults(formato) {
            if(currentResults.length === 0) {
                alert('Realiza un an치lisis primero');
                return;
            }

            fetch('/api/offline/exportar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({formato: formato, resultados: currentResults})
            })
            .then(r => r.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `analisis_${new Date().toISOString().slice(0,10)}.${formato}`;
                a.click();
            });
        }

        function exportChart(chartId) {
            console.log('游꿛 Exportando gr치fico:', chartId);
            
            const canvas = document.getElementById(chartId);
            if (!canvas) {
                showNotification('Gr치fico no encontrado', 'error');
                return;
            }
            
            // Verificar que el gr치fico existe y tiene datos
            if (!window.charts || !window.charts[chartId.replace('-chart', '')]) {
                showNotification('No hay datos para exportar', 'warning');
                return;
            }
            
            const format = prompt('Formato de imagen (png/svg):', 'png') || 'png';
            
            try {
                let url;
                let filename;
                
                if (format === 'svg') {
                    // Para SVG, necesitamos una librer칤a adicional o crear el SVG manualmente
                    showNotification('SVG requiere configuraci칩n adicional. Usando PNG...', 'info');
                    url = canvas.toDataURL('image/png');
                    filename = `grafico_${chartId}_${new Date().toISOString().slice(0,10)}.png`;
                } else {
                    // PNG por defecto
                    url = canvas.toDataURL('image/png');
                    filename = `grafico_${chartId}_${new Date().toISOString().slice(0,10)}.png`;
                }
                
                // Crear enlace de descarga
                const link = document.createElement('a');
                link.download = filename;
                link.href = url;
                link.target = '_blank'; // Abrir en nueva pesta침a si el download falla
                
                // Forzar descarga en m칩viles
                if (navigator.userAgent.match(/iPhone|iPad|iPod|Android/i)) {
                    link.target = '_blank';
                }
                
                // A침adir al DOM, hacer click, y eliminar
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Limpiar memoria
                setTimeout(() => {
                    window.URL.revokeObjectURL(url);
                }, 100);
                
                showNotification(`游늵 Gr치fico exportado como ${filename}`, 'success');
                
            } catch (error) {
                console.error('仇 Error exportando gr치fico:', error);
                showNotification('Error al exportar el gr치fico', 'error');
            }
        }

        function switchMode() {
            window.location.href = 'online.html';
        }

        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(section + '-section').classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            event.target.closest('.nav-btn').classList.add('active');
        }

        function deleteCripto(nombre) {
            if(!confirm(`쮼liminar ${nombre}?`)) return;
            
            fetch(`/api/offline/eliminar/${nombre}`, {method: 'DELETE'})
                .then(r => r.json())
                .then(data => {
                    if(data.success) {
                        loadAvailableCriptos();
                    }
                });
        }

        function showDetail(cripto) {
            const resultado = currentResults.find(r => r.cripto === cripto);
            if(!resultado) return;
            
            alert(`Detalle de ${cripto}:\n` +
                  `Precio: $${resultado.precio_actual.toLocaleString()}\n` +
                  `RSI: ${resultado.indicadores.rsi.toFixed(1)}\n` +
                  `MACD: ${resultado.indicadores.macd.toFixed(2)}\n` +
                  `Decisi칩n: ${resultado.decision_info.decision}\n` +
                  `Confianza: ${(resultado.decision_info.confianza * 100).toFixed(0)}%\n\n` +
                  `Razones:\n${resultado.decision_info.razones.join('\n')}`);
        }
    </script>

    <script>
    
    async function runSimulation() {
        const btn = document.getElementById('sim-btn');
        const resultsDiv = document.getElementById('simulation-results');

        const params = {
            precio_inicial: parseFloat(document.getElementById('sim-precio').value),
            dias: parseInt(document.getElementById('sim-dias').value),
            volatilidad: parseFloat(document.getElementById('sim-vol').value) / 100,
            tendencia: parseFloat(document.getElementById('sim-trend').value) / 100,
            nombre: document.getElementById('sim-nombre').value.trim()
        };

        if (!params.nombre) {
            alert('Por favor ingresa un nombre para la simulaci칩n');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando...';

        try {
            // 1. Generar la simulaci칩n
            const simResponse = await fetch('/api/offline/simulacion', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(params)
            });

            const simData = await simResponse.json();
            
            if (!simResponse.ok || !simData.success) {
                throw new Error(simData.error || 'Error en la simulaci칩n');
            }

            console.log('九 Simulaci칩n generada:', simData);

            // 2. Analizar la simulaci칩n
            const analisisResponse = await fetch('/api/offline/simulacion/analizar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre: params.nombre })
            });

            const analisis = await analisisResponse.json();
            
            if (!analisisResponse.ok || analisis.error) {
                throw new Error(analisis.error || 'Error analizando simulaci칩n');
            }

            console.log('九 An치lisis completo:', analisis);

            // 3. Mostrar resultados (SIN recargar la lista general)
            mostrarResultadosSimulacion(analisis);
            resultsDiv.style.display = 'block';

            // 4. 仇 NO recargar la lista de criptomonedas disponibles
            // loadAvailableCriptos(); // <-- ELIMINAR ESTA L칈NEA

        } catch (error) {
            console.error('仇 Error en simulaci칩n:', error);
            alert('Error en simulaci칩n: ' + error.message);
            
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                <div class="error" style="padding: 2rem; text-align: center;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--danger-color); margin-bottom: 1rem;"></i>
                    <h4>Error en la simulaci칩n</h4>
                    <p style="color: var(--text-secondary);">${error.message}</p>
                </div>
            `;
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-play"></i> Generar Simulaci칩n';
        }
    }

function mostrarResultadosSimulacion(data) {
    console.log('游늵 Mostrando resultados de simulaci칩n mejorados:', data);

    const statsDiv = document.getElementById('simulation-stats');
    const tableBody = document.querySelector('#simulation-metrics-table tbody');
    const iaDiv = document.getElementById('simulation-ia-interpretation');

    // 游늵 Estad칤sticas principales
    const precios = data.precios;
    const retornos = precios.map((p, i) => i > 0 ? (p - precios[i - 1]) / precios[i - 1] : 0).slice(1);
    const volatilidad = Math.sqrt(retornos.reduce((acc, r) => acc + r ** 2, 0) / retornos.length) * Math.sqrt(365) * 100;
    const sharpe = (data.cambio_total / 100) / (volatilidad / 100);
    const maxDrawdown = Math.max(...precios.map((p, i) => {
        const maxPrev = Math.max(...precios.slice(0, i + 1));
        return (maxPrev - p) / maxPrev * 100;
    }));
    const var95 = percentile(retornos, 5) * 100;

    statsDiv.innerHTML = `
        <div class="stat-card-mini">
            <div class="label">Precio Final</div>
            <div class="value" style="color: ${data.cambio_total >= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">
                $${data.precio_actual.toLocaleString()}
            </div>
        </div>
        <div class="stat-card-mini">
            <div class="label">Cambio Total</div>
            <div class="value" style="color: ${data.cambio_total >= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">
                ${data.cambio_total.toFixed(2)}%
            </div>
        </div>
        <div class="stat-card-mini">
            <div class="label">Volatilidad Anual</div>
            <div class="value">${volatilidad.toFixed(2)}%</div>
        </div>
        <div class="stat-card-mini">
            <div class="label">Sharpe Ratio</div>
            <div class="value" style="color: ${sharpe > 1 ? 'var(--success-color)' : 'var(--warning-color)'};">
                ${sharpe.toFixed(2)}
            </div>
        </div>
        <div class="stat-card-mini">
            <div class="label">VaR 95%</div>
            <div class="value" style="color: var(--danger-color);">
                ${var95.toFixed(2)}%
            </div>
        </div>
        <div class="stat-card-mini">
            <div class="label">Max Drawdown</div>
            <div class="value" style="color: var(--danger-color);">
                ${maxDrawdown.toFixed(2)}%
            </div>
        </div>
    `;

    // 游늶 Tabla de m칠tricas
    const metrics = [
        { name: 'Precio Inicial', value: `$${data.precio_inicial.toLocaleString()}`, interpretacion: 'Valor inicial de la simulaci칩n' },
        { name: 'Precio Final', value: `$${data.precio_actual.toLocaleString()}`, interpretacion: data.cambio_total >= 0 ? 'Final positivo' : 'Final negativo' },
        { name: 'Cambio Total', value: `${data.cambio_total.toFixed(2)}%`, interpretacion: data.cambio_total >= 0 ? 'Ganancia neta' : 'P칠rdida neta' },
        { name: 'Volatilidad Anualizada', value: `${volatilidad.toFixed(2)}%`, interpretacion: volatilidad > 50 ? 'Alta volatilidad' : volatilidad > 25 ? 'Media volatilidad' : 'Baja volatilidad' },
        { name: 'Sharpe Ratio', value: sharpe.toFixed(2), interpretacion: sharpe > 1 ? 'Buen rendimiento ajustado a riesgo' : sharpe > 0 ? 'Rendimiento aceptable' : 'Mal rendimiento' },
        { name: 'VaR 95%', value: `${var95.toFixed(2)}%`, interpretacion: 'P칠rdida m치xima esperada con 95% confianza' },
        { name: 'M치ximo Precio', value: `$${data.maximo.toLocaleString()}`, interpretacion: 'Precio m치s alto alcanzado' },
        { name: 'M칤nimo Precio', value: `$${data.minimo.toLocaleString()}`, interpretacion: 'Precio m치s bajo alcanzado' },
        { name: 'Max Drawdown', value: `${maxDrawdown.toFixed(2)}%`, interpretacion: 'M치xima ca칤da desde un pico' }
    ];

    // Crear visualizaci칩n sofisticada de m칠tricas
    const metricsContainer = document.getElementById('simulation-metrics-table').parentElement;
    const metricsHTML = metrics.map(m => {
        // Determinar color seg칰n tipo de m칠trica
        let bgColor = 'rgba(99, 102, 241, 0.1)';
        let borderColor = 'rgba(99, 102, 241, 0.3)';
        let accentColor = '#6366F1';
        let icon = '游늵';
        
        if (m.name.includes('Retorno') || m.name.includes('Performance')) {
            bgColor = 'rgba(76, 175, 80, 0.1)';
            borderColor = 'rgba(76, 175, 80, 0.3)';
            accentColor = '#4CAF50';
            icon = '游늳';
        } else if (m.name.includes('Riesgo') || m.name.includes('Volatilidad') || m.name.includes('Drawdown') || m.name.includes('VaR')) {
            bgColor = 'rgba(244, 67, 54, 0.1)';
            borderColor = 'rgba(244, 67, 54, 0.3)';
            accentColor = '#F44336';
            icon = '丘멆잺';
        } else if (m.name.includes('Sharpe') || m.name.includes('Ratio')) {
            bgColor = 'rgba(255, 193, 7, 0.1)';
            borderColor = 'rgba(255, 193, 7, 0.3)';
            accentColor = '#FFC107';
            icon = '丘';
        } else if (m.name.includes('Precio')) {
            bgColor = 'rgba(33, 150, 243, 0.1)';
            borderColor = 'rgba(33, 150, 243, 0.3)';
            accentColor = '#2196F3';
            icon = '游눯';
        }
        
        return `
            <tr style="background: ${bgColor}; border-left: 4px solid ${accentColor}; transition: all 0.3s ease;">
                <td style="padding: 1rem; font-weight: 600; color: ${accentColor}; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.2rem;">${icon}</span>
                    ${m.name}
                </td>
                <td style="padding: 1rem; font-size: 1.1rem; font-weight: 700; color: var(--text-primary);">
                    ${m.value}
                </td>
                <td style="padding: 1rem; color: var(--text-secondary); font-size: 0.9rem; max-width: 300px;">
                    ${m.interpretacion}
                </td>
            </tr>
        `;
    }).join('');
    
    tableBody.innerHTML = metricsHTML;

    // 游 Interpretaci칩n IA
    const performanceRating = data.cambio_total > 0 && sharpe > 0.5 && maxDrawdown < 30 ? 'Favorable' : 
                             data.cambio_total > 0 && sharpe > 0 ? 'Moderado' : 'Riesgoso';
    const riskLevel = volatilidad > 50 ? 'Alto' : volatilidad > 25 ? 'Medio' : 'Bajo';
    
    iaDiv.innerHTML = `
        <div style="line-height: 1.8; font-size: 1rem;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-dark); border-radius: 8px;">
                <div style="padding: 0.75rem; border-left: 4px solid ${data.cambio_total >= 0 ? '#4CAF50' : '#F44336'};">
                    <span style="display: block; color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem;">RENDIMIENTO TOTAL</span>
                    <span style="display: block; font-size: 1.5rem; font-weight: 700; color: ${data.cambio_total >= 0 ? '#4CAF50' : '#F44336'};">
                        ${data.cambio_total >= 0 ? '' : ''} ${Math.abs(data.cambio_total).toFixed(2)}%
                    </span>
                </div>
                <div style="padding: 0.75rem; border-left: 4px solid #FFC107;">
                    <span style="display: block; color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem;">RATIO SHARPE</span>
                    <span style="display: block; font-size: 1.5rem; font-weight: 700; color: #FFC107;">
                        ${sharpe.toFixed(2)}
                    </span>
                </div>
            </div>
            
            <p style="margin-bottom: 1rem; padding: 1rem; background: rgba(33, 150, 243, 0.1); border-radius: 8px; border-left: 4px solid #2196F3;">
                <strong style="color: #2196F3;">Resumen:</strong> La simulaci칩n muestra un <strong>${data.cambio_total >= 0 ? 'crecimiento' : 'descenso'} del ${Math.abs(data.cambio_total).toFixed(2)}%</strong> sobre el precio inicial de <strong>$${data.precio_inicial.toLocaleString('es-ES', {maximumFractionDigits: 2})}</strong>, con un rendimiento <strong>${performanceRating}</strong>.
            </p>
            
            <p style="margin-bottom: 1rem; padding: 1rem; background: rgba(76, 175, 80, 0.1); border-radius: 8px; border-left: 4px solid #4CAF50;">
                <strong style="color: #4CAF50;">Volatilidad:</strong> La volatilidad anualizada es del <strong>${volatilidad.toFixed(2)}%</strong>, lo que indica un nivel de riesgo <strong>${riskLevel}</strong>. El Sharpe ratio de <strong>${sharpe.toFixed(2)}</strong> sugiere que el rendimiento ${sharpe > 1 ? 'compensa bien el riesgo asumido' : sharpe > 0 ? 'es aceptable' : 'no compensa el riesgo'}.
            </p>
            
            <p style="margin-bottom: 1rem; padding: 1rem; background: rgba(244, 67, 54, 0.1); border-radius: 8px; border-left: 4px solid #F44336;">
                <strong style="color: #F44336;">Riesgo de Ca칤da:</strong> El drawdown m치ximo fue del <strong>${maxDrawdown.toFixed(2)}%</strong>, lo que representa la mayor ca칤da desde un pico durante la simulaci칩n. Esto es <strong>${maxDrawdown < 20 ? 'muy bajo' : maxDrawdown < 40 ? 'moderado' : 'significativo'}</strong>.
            </p>
            
            <p style="padding: 1rem; background: linear-gradient(135deg, var(--secondary-color), rgba(124, 58, 237, 0.3)); border-radius: 8px; border-left: 4px solid var(--secondary-color);">
                <strong style="color: var(--secondary-color);">Conclusi칩n:</strong> ${data.cambio_total > 0 && sharpe > 0.5 && maxDrawdown < 30 
                    ? 'La simulaci칩n muestra un escenario favorable con buen rendimiento y riesgo controlado. Los indicadores t칠cnicos son positivos para una inversi칩n.'
                    : data.cambio_total > 0 && sharpe > 0
                    ? 'La simulaci칩n presenta un desempe침o positivo pero con riesgos moderados. Requiere atenci칩n a la volatilidad.'
                    : 'La simulaci칩n presenta riesgos significativos. Se recomienda revisar los par치metros o considerar estrategias defensivas.'}
            </p>
        </div>
    `;

    // 游늳 Gr치ficos
    drawSimulationCharts(data, retornos, precios, volatilidad, maxDrawdown);
}

// Funci칩n auxiliar para percentiles
function percentile(arr, p) {
    const sorted = arr.slice().sort((a, b) => a - b);
    const index = Math.ceil(sorted.length * (p / 100)) - 1;
    return sorted[index];
}

function drawSimulationCharts(data, retornos, precios, volatilidad, maxDrawdown) {
    // 1. Gr치fico de l칤nea con bandas
    const ctxLine = document.getElementById('simulation-chart-line');
    if (window.charts.simLine) window.charts.simLine.destroy();
    window.charts.simLine = new Chart(ctxLine, {
        type: 'line',
        data: {
            labels: data.fechas,
            datasets: [{
                label: 'Precio Simulado',
                data: precios,
                borderColor: '#2196F3',
                backgroundColor: 'rgba(33, 150, 243, 0.1)',
                fill: true,
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                title: {
                    display: true,
                    text: `Simulaci칩n Monte Carlo - ${data.nombre}`,
                    color: '#F1F5F9'
                }
            },
            scales: {
                y: {
                    ticks: {
                        callback: value => '$' + value.toLocaleString(),
                        color: '#94A3B8'
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: {
                    ticks: { color: '#94A3B8' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
// 2. Histograma de retornos
const ctxHist = document.getElementById('simulation-histogram');
if (window.charts.simHist) window.charts.simHist.destroy();
const histData = retornos.map(r => r * 100);

// Crear bins para histograma
const bins = 20;
const min = Math.min(...histData);
const max = Math.max(...histData);
const step = (max - min) / bins;
const labels = [];
const counts = [];

for (let i = 0; i < bins; i++) {
    const lower = min + i * step;
    const upper = min + (i + 1) * step;
    const count = histData.filter(v => v >= lower && v < upper).length;
    labels.push(`${lower.toFixed(2)}%`);
    counts.push(count);
}

window.charts.simHist = new Chart(ctxHist, {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [{
            label: 'Frecuencia',
            data: counts,
            backgroundColor: 'rgba(76, 175, 80, 0.6)',
            borderColor: '#4CAF50',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            title: {
                display: true,
                text: 'Distribuci칩n de Retornos Diarios',
                color: '#F1F5F9'
            }
        },
        scales: {
            x: {
                title: {
                    display: true,
                    text: 'Rango de Retorno (%)',
                    color: '#94A3B8'
                },
                ticks: { color: '#94A3B8' },
                grid: { display: false }
            },
            y: {
                title: {
                    display: true,
                    text: 'Frecuencia',
                    color: '#94A3B8'
                },
                ticks: { color: '#94A3B8' },
                grid: { color: 'rgba(255,255,255,0.1)' }
            }
        }
    }
});
    // 3. Drawdown
    const ctxDD = document.getElementById('simulation-drawdown');
    if (window.charts.simDD) window.charts.simDD.destroy();
    const drawdowns = precios.map((p, i) => {
        const maxPrev = Math.max(...precios.slice(0, i + 1));
        return (maxPrev - p) / maxPrev * 100;
    });
    window.charts.simDD = new Chart(ctxDD, {
        type: 'line',
        data: {
            labels: data.fechas,
            datasets: [{
                label: 'Drawdown (%)',
                data: drawdowns,
                borderColor: '#F44336',
                backgroundColor: 'rgba(244, 67, 54, 0.2)',
                fill: true,
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                title: {
                    display: true,
                    text: 'Drawdown a lo largo del tiempo',
                    color: '#F1F5F9'
                }
            },
            scales: {
                y: {
                    ticks: {
                        callback: value => value.toFixed(1) + '%',
                        color: '#94A3B8'
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: {
                    ticks: { color: '#94A3B8' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });

        // 4. Bandas de Confianza (percentiles 5, 50, 95)
    const ctxBands = document.getElementById('simulation-bands');
    if (window.charts.simBands) window.charts.simBands.destroy();

    // Recalcular percentiles diarios de las trayectorias (simulados aqu칤 por simplicidad)
    const upper = precios.map(p => p * 1.15); // percentil 95 simulado
    const lower = precios.map(p => p * 0.85); // percentil 5  simulado
    const median = precios;                   // percentil 50 (media)

    window.charts.simBands = new Chart(ctxBands, {
        type: 'line',
        data: {
            labels: data.fechas,
            datasets: [
                {
                    label: 'Percentil 95',
                    data: upper,
                    borderColor: 'rgba(76, 175, 80, 0.3)',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    fill: '+1',
                    pointRadius: 0
                },
                {
                    label: 'Trayectoria Media',
                    data: median,
                    borderColor: '#2196F3',
                    backgroundColor: 'transparent',
                    fill: false,
                    pointRadius: 0
                },
                {
                    label: 'Percentil 5',
                    data: lower,
                    borderColor: 'rgba(244, 67, 54, 0.3)',
                    backgroundColor: 'rgba(244, 67, 54, 0.1)',
                    fill: '-1',
                    pointRadius: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                title: {
                    display: true,
                    text: 'Bandas de Confianza (Percentiles 5-95)',
                    color: '#F1F5F9'
                }
            },
            scales: {
                y: {
                    ticks: {
                        callback: value => '$' + value.toLocaleString(),
                        color: '#94A3B8'
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: {
                    ticks: { color: '#94A3B8' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

</script>

<script>
// 游늵 GR츼FICOS PARA SECCI칍N DE AN츼LISIS OFFLINE
let offlineCharts = {};

function inicializarGraficosOffline() {
    console.log("游꿛 Inicializando gr치ficos offline...");
    
    // Gr치fico de Se침ales
    const ctxSignals = document.getElementById('offline-signals-chart');
    if (ctxSignals) {
        offlineCharts.signals = new Chart(ctxSignals, {
            type: 'doughnut',
            data: {
                labels: ['Compra', 'Venta', 'Mantener'],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: ['#4CAF50', '#F44336', '#FFC107'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#f1f5f9' }
                    }
                }
            }
        });
    }

    // Gr치fico de Confianza
    const ctxConfidence = document.getElementById('offline-confidence-chart');
    if (ctxConfidence) {
        offlineCharts.confidence = new Chart(ctxConfidence, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Confianza (%)',
                    data: [],
                    backgroundColor: '#2196F3',
                    borderColor: '#1976D2',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: value => value + '%',
                            color: '#f1f5f9'
                        },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    x: {
                        ticks: { color: '#f1f5f9' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    }
                }
            }
        });
    }

    // Gr치fico de Volumen
    const ctxVolume = document.getElementById('offline-volume-chart');
    if (ctxVolume) {
        offlineCharts.volume = new Chart(ctxVolume, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Volumen 24h',
                    data: [],
                    backgroundColor: 'rgba(33, 150, 243, 0.8)',
                    borderColor: '#2196F3',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        ticks: {
                            callback: value => '$' + value.toLocaleString(),
                            color: '#f1f5f9'
                        },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    x: {
                        ticks: { color: '#f1f5f9' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    }
                }
            }
        });
    }

    console.log("九 Gr치ficos offline inicializados");
}

function actualizarGraficosOfflineConDatos(resultados) {
    if (!resultados || resultados.length === 0) return;

    console.log("游늵 Actualizando gr치ficos offline con", resultados.length, "resultados");

    // Preparar datos para gr치ficos
    const labels = [];
    const confidenceData = [];
    const volumeData = [];
    let compras = 0, ventas = 0, mantener = 0;

    resultados.forEach(resultado => {
        if (!resultado.success) return;

        const cripto = resultado.cripto;
        labels.push(cripto);
        confidenceData.push(Math.round(resultado.decision_info.confianza * 100));
        volumeData.push(resultado.estadisticas.volume_24h || 0);

        // Contar se침ales
        if (resultado.decision_info.decision.includes('COMPRAR')) compras++;
        else if (resultado.decision_info.decision.includes('VENDER')) ventas++;
        else mantener++;
    });

    // Actualizar gr치fico de se침ales
    if (offlineCharts.signals) {
        offlineCharts.signals.data.datasets[0].data = [compras, ventas, mantener];
        offlineCharts.signals.update();
    }

    // Actualizar gr치fico de confianza
    if (offlineCharts.confidence) {
        offlineCharts.confidence.data.labels = labels;
        offlineCharts.confidence.data.datasets[0].data = confidenceData;
        offlineCharts.confidence.update();
    }

    // Actualizar gr치fico de volumen
    if (offlineCharts.volume) {
        offlineCharts.volume.data.labels = labels;
        // Usar volume_24h o volume_actual si existe, sino usar 0
        const volumeActualData = resultados.map(r => {
            if (!r.success) return 0;
            return r.estadisticas?.volume_24h || 
                   r.estadisticas?.volume_actual || 
                   r.estadisticas?.volumen_24h || 
                   0;
        });
        offlineCharts.volume.data.datasets[0].data = volumeActualData;
        offlineCharts.volume.update();
        console.log("游늵 Datos de volumen:", volumeActualData);
    }

    // Actualizar estad칤sticas
    actualizarEstadisticasOffline(resultados);
}

function actualizarEstadisticasOffline(resultados) {
    const statsGrid = document.getElementById('offline-stats-grid');
    if (!statsGrid) return;

    // Calcular estad칤sticas
    const total = resultados.length;
    const compras = resultados.filter(r => r.success && r.decision_info.decision.includes('COMPRAR')).length;
    const ventas = resultados.filter(r => r.success && r.decision_info.decision.includes('VENDER')).length;
    const confianzaPromedio = resultados.reduce((acc, r) => acc + (r.success ? r.decision_info.confianza : 0), 0) / total;

    statsGrid.innerHTML = `
        <div class="stat-card-mini">
            <div class="label">Total Analizadas</div>
            <div class="value">${total}</div>
        </div>
        <div class="stat-card-mini">
            <div class="label">Se침ales de Compra</div>
            <div class="value" style="color: #4CAF50;">${compras}</div>
        </div>
        <div class="stat-card-mini">
            <div class="label">Se침ales de Venta</div>
            <div class="value" style="color: #F44336;">${ventas}</div>
        </div>
        <div class="stat-card-mini">
            <div class="label">Confianza Promedio</div>
            <div class="value">${(confianzaPromedio * 100).toFixed(0)}%</div>
        </div>
    `;
}

function actualizarGraficoAnalisis(tipo) {
    console.log(`游댃 Actualizando gr치fico offline: ${tipo}`);
    
    // Si ya hay resultados, actualizar con ellos
    if (window.currentOfflineResults && window.currentOfflineResults.length > 0) {
        actualizarGraficosOfflineConDatos(window.currentOfflineResults);
    } else {
        console.log("좶잺 No hay datos para actualizar el gr치fico");
    }
}

// Inicializar cuando se carga la p치gina
document.addEventListener('DOMContentLoaded', () => {
    inicializarGraficosOffline();
});
</script>


<script>
    // Funci칩n auxiliar para mostrar notificaciones
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        <span>${message}</span>
    `;
    
    // Estilos para la notificaci칩n
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        z-index: 1000;
        transform: translateX(400px);
        transition: transform 0.3s ease;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    `;
    
    document.body.appendChild(notification);
    
    // Mostrar con animaci칩n
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
        
        // Auto-ocultar despu칠s de 4 segundos
        setTimeout(() => {
            notification.style.transform = 'translateX(400px)';
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    }, 100);
}

// ============= L칍GICA DEL MINIJUEGO "쮺OMPRAR O ESPERAR?" =============
let fomoGameState = {
    cripto: null,
    data: [],
    spikeIndex: 0,
    userDecision: null,
    countdownTimer: null,
    timeRemaining: 10,
    gameActive: false
};

// Inicializar selector de criptomonedas
function initializeFomoSelector() {
    const selector = document.getElementById('fomo-cripto-select');
    if (!selector) return;
    
    if (availableCriptos && availableCriptos.length > 0) {
        selector.innerHTML = '<option value="">-- Elige una criptomoneda --</option>' +
            availableCriptos.map(c => `<option value="${c}">${c}</option>`).join('');
        console.log('[v0] Selector FOMO inicializado con:', availableCriptos.length, 'criptomonedas');
    } else {
        console.log('[v0] Sin datos de criptomonedas disponibles');
    }
}



// Buscar picos de precio en los datos
function findPriceSpike(data) {
    if (!data || data.length < 8) {
        console.log('[v0] Datos insuficientes:', data?.length || 0);
        return null;
    }
    
    console.log('[v0] Buscando spikes en', data.length, 'puntos de datos');
    
    // Buscar momento donde el precio subi칩 +3% o m치s (m치s flexible)
    const searchStart = 2;
    const searchEnd = data.length - 3;
    
    for (let i = searchStart; i < searchEnd; i++) {
        const basePrice = data[i - 2].close;
        
        // Buscar el m치ximo en ventana despu칠s del punto actual
        const windowEnd = Math.min(i + 4, data.length);
        const peakPrice = Math.max(...data.slice(i, windowEnd).map(d => d.close));
        const peakIndex = data.slice(i, windowEnd).findIndex(d => d.close === peakPrice) + i;
        
        if (basePrice <= 0 || !peakPrice) continue;
        
        const percentageChange = ((peakPrice - basePrice) / basePrice) * 100;
        
        console.log(`[v0] Punto ${i}: cambio = ${percentageChange.toFixed(2)}%`);
        
        // Buscar cambios significativos (>= 3%)
        if (percentageChange >= 3) {
            const spike = {
                index: i,
                basePrice: basePrice,
                peakPrice: peakPrice,
                percentageChange: percentageChange,
                timestamp: data[i].timestamp,
                peakIndex: peakIndex
            };
            console.log('[v0] Spike encontrado:', spike);
            return spike;
        }
    }
    
    console.log('[v0] No se encontraron spikes de precio');
    return null;
}

// Encontrar escenarios diversos en los datos hist칩ricos
function findDiverseScenarios(data) {
    if (data.length < 40) return [];
    
    const scenarios = [];
    const step = Math.floor(data.length / 8); // Dividir el hist칩rico en 8 secciones
    
    for (let section = 1; section < 8; section++) {
        const sectionStart = section * step;
        const sectionEnd = Math.min(sectionStart + step, data.length);
        
        // Buscar volatilidad en esta secci칩n
        for (let i = sectionStart + 5; i < sectionEnd - 5; i++) {
            const windowStart = Math.max(0, i - 5);
            const windowEnd = Math.min(i + 5, data.length - 1);
            const window = data.slice(windowStart, windowEnd + 1);
            
            const minPrice = Math.min(...window.map(d => d.close));
            const maxPrice = Math.max(...window.map(d => d.close));
            const volatility = (maxPrice - minPrice) / minPrice * 100;
            
            if (volatility > 1) { // Al menos 1% de volatilidad
                const basePrice = data[i - 1].close;
                const currentPrice = data[i].close;
                const percentChange = ((currentPrice - basePrice) / basePrice) * 100;
                
                // Calcular resultado futuro
                const futureWindow = data.slice(i + 1, Math.min(i + 21, data.length));
                if (futureWindow.length > 0) {
                    const futureMax = Math.max(...futureWindow.map(d => d.close));
                    const futureMin = Math.min(...futureWindow.map(d => d.close));
                    const futureClose = futureWindow[futureWindow.length - 1].close;
                    
                    const bestOutcome = ((futureMax - currentPrice) / currentPrice) * 100;
                    const worstOutcome = ((futureMin - currentPrice) / currentPrice) * 100;
                    const realOutcome = ((futureClose - currentPrice) / currentPrice) * 100;
                    
                    scenarios.push({
                        index: i,
                        basePrice,
                        currentPrice,
                        percentChange,
                        volatility,
                        futureData: futureWindow,
                        bestOutcome,
                        worstOutcome,
                        realOutcome,
                        timestamp: data[i].timestamp
                    });
                }
            }
        }
    }
    
    return scenarios.filter(s => s.realOutcome !== null);
}

// Iniciar el minijuego
async function startFomoGame() {
    const cripto = document.getElementById('fomo-cripto-select').value;
    
    if (!cripto) {
        showNotification('Por favor selecciona una criptomoneda', 'warning');
        return;
    }
    
    try {
        console.log('[v0] Iniciando FOMO Game para:', cripto);
        
        // Obtener datos de la criptomoneda
        const response = await fetch(`/api/offline/obtener-datos/${cripto}`);
        console.log('[v0] Response status:', response.status);
        
        const result = await response.json();
        console.log('[v0] API Response:', result);
        
        if (!response.ok || !result.success) {
            console.error('[v0] API Error:', result.error);
            showNotification('Error: ' + (result.error || 'No se pudieron cargar los datos'), 'error');
            return;
        }
        
        if (!result.datos || result.datos.length === 0) {
            console.error('[v0] Sin datos en respuesta');
            showNotification('No hay datos disponibles para esta criptomoneda', 'error');
            return;
        }
        
        console.log('[v0] Datos recibidos:', result.datos.length, 'registros');
        fomoGameState.data = result.datos;
        fomoGameState.cripto = cripto;
        
        // Buscar escenarios diversos
        console.log('[v0] Buscando escenarios...');
        const scenarios = findDiverseScenarios(fomoGameState.data);
        console.log('[v0] Total de datos:', fomoGameState.data.length);
        console.log('[v0] Escenarios encontrados:', scenarios.length);
        if (scenarios.length > 0) {
            console.log('[v0] Primer escenario - Volatilidad:', scenarios[0].volatility.toFixed(2) + '%', 'Cambio:', scenarios[0].percentChange.toFixed(2) + '%');
        }
        
        if (scenarios.length === 0) {
            console.error('[v0] No se encontraron escenarios');
            showNotification('No se encontraron momentos de volatilidad en los datos', 'warning');
            return;
        }
        
        // Seleccionar un escenario aleatorio
        const scenario = scenarios[Math.floor(Math.random() * scenarios.length)];
        fomoGameState.spikeIndex = scenario.index;
        fomoGameState.scenario = scenario;
        console.log('[v0] Escenario seleccionado:', scenario);
        
        // Mostrar juego
        console.log('[v0] Mostrando interfaz de juego');
        document.getElementById('fomo-setup-section').style.display = 'none';
        document.getElementById('fomo-game-play').style.display = 'block';
        document.getElementById('fomo-results').style.display = 'none';
        
        // Dibujar gr치fico
        console.log('[v0] Dibujando gr치fico...');
        drawFomoChartFromScenario(scenario);
        console.log('[v0] Gr치fico dibujado');
        
        // Actualizar informaci칩n
        document.getElementById('fomo-current-price').textContent = `$${scenario.currentPrice.toLocaleString('es-ES', {maximumFractionDigits: 2})}`;
        const priceChangeText = scenario.percentChange > 0 ? '+' : '';
        document.getElementById('fomo-price-change').textContent = `${priceChangeText}${scenario.percentChange.toFixed(2)}%`;
        document.getElementById('fomo-price-change').style.color = scenario.percentChange > 0 ? '#00ff88' : '#ff6b6b';
        
        // Desactivar botones e iniciar cuenta regresiva
        fomoGameState.gameActive = true;
        fomoGameState.timeRemaining = 10;
        fomoGameState.userDecision = null;
        
        document.getElementById('buy-btn').disabled = false;
        document.getElementById('wait-btn').disabled = false;
        
        // Cuenta regresiva
        startCountdown();
        
    } catch (error) {
        console.error('[v0] Error en FOMO Game:', error);
        showNotification('Error al cargar datos', 'error');
    }
}

// Dibujar gr치fico del minijuego
function drawFomoChart(spike) {
    console.log('[v0] drawFomoChart iniciado');
    
    const ctx = document.getElementById('fomo-game-chart');
    console.log('[v0] Canvas elemento:', ctx);
    
    if (!ctx) {
        console.error('[v0] ERROR: No se encontr칩 canvas #fomo-game-chart');
        return;
    }
    
    // Destruir gr치fico anterior si existe
    if (window.fomoChart) {
        console.log('[v0] Destruyendo gr치fico anterior');
        window.fomoChart.destroy();
    }
    
    // Mostrar datos hasta el pico (10 velas antes + pico)
    const startIdx = Math.max(0, spike.index - 10);
    const chartData = fomoGameState.data.slice(startIdx, spike.index + 1);
    
    console.log('[v0] Datos para gr치fico:', chartData.length, 'elementos');
    console.log('[v0] Primero:', chartData[0], '칔ltimo:', chartData[chartData.length - 1]);
    
    const labels = chartData.map((d, i) => i === chartData.length - 1 ? 'AHORA' : '');
    const prices = chartData.map(d => d.close);
    
    console.log('[v0] Precios:', prices);
    console.log('[v0] Creando Chart...');
    
    try {
        window.fomoChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: `${fomoGameState.cripto} - Precio`,
                data: prices,
                borderColor: '#ffc500',
                backgroundColor: 'rgba(255, 197, 0, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.3,
                pointBackgroundColor: prices.map((_, i) => i === prices.length - 1 ? '#ff6b6b' : '#ffc500'),
                pointRadius: prices.map((_, i) => i === prices.length - 1 ? 8 : 4),
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                title: {
                    display: true,
                    text: `Hist칩rico de ${fomoGameState.cripto} - Momento de Decisi칩n`,
                    color: '#f1f5f9'
                }
            },
            scales: {
                y: {
                    ticks: {
                        color: '#94a3b8',
                        callback: value => `$${value.toLocaleString()}`
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: {
                    ticks: { color: '#94a3b8' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
        console.log('[v0] Chart creado exitosamente');
    } catch (error) {
        console.error('[v0] Error creando Chart:', error);
    }
}

// Dibujar gr치fico del minijuego desde un escenario
function drawFomoChartFromScenario(scenario) {
    console.log('[v0] drawFomoChartFromScenario iniciado');
    
    const ctx = document.getElementById('fomo-game-chart');
    console.log('[v0] Canvas elemento:', ctx);
    
    if (!ctx) {
        console.error('[v0] ERROR: No se encontr칩 canvas #fomo-game-chart');
        return;
    }
    
    // Destruir gr치fico anterior si existe
    if (window.fomoChart) {
        console.log('[v0] Destruyendo gr치fico anterior');
        window.fomoChart.destroy();
    }
    
    // Obtener datos hist칩ricos hasta el punto de decisi칩n
    const startIdx = Math.max(0, scenario.index - 15);
    const endIdx = scenario.index + 1;
    const chartData = fomoGameState.data.slice(startIdx, endIdx);
    
    console.log('[v0] Datos para gr치fico:', chartData.length, 'elementos');
    
    const labels = chartData.map((d, i) => i === chartData.length - 1 ? 'AHORA' : '');
    const prices = chartData.map(d => d.close);
    
    console.log('[v0] Precios:', prices);
    console.log('[v0] Creando Chart...');
    
    try {
        window.fomoChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: `${fomoGameState.cripto} - Precio`,
                data: prices,
                borderColor: '#ffc500',
                backgroundColor: 'rgba(255, 197, 0, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.3,
                pointBackgroundColor: prices.map((_, i) => i === prices.length - 1 ? '#ff6b6b' : '#ffc500'),
                pointRadius: prices.map((_, i) => i === prices.length - 1 ? 8 : 4),
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                title: {
                    display: true,
                    text: `Hist칩rico de ${fomoGameState.cripto} - Momento de Decisi칩n`,
                    color: '#f1f5f9'
                }
            },
            scales: {
                y: {
                    ticks: {
                        color: '#94a3b8',
                        callback: value => `$${value.toLocaleString()}`
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: {
                    ticks: { color: '#94a3b8' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
        console.log('[v0] Chart creado exitosamente');
    } catch (error) {
        console.error('[v0] Error creando Chart:', error);
    }
}

// Cuenta regresiva
function startCountdown() {
    fomoGameState.timeRemaining = 10;
    
    fomoGameState.countdownTimer = setInterval(() => {
        fomoGameState.timeRemaining--;
        document.getElementById('fomo-countdown').textContent = `${fomoGameState.timeRemaining}s`;
        
        if (fomoGameState.timeRemaining <= 0) {
            clearInterval(fomoGameState.countdownTimer);
            if (!fomoGameState.userDecision) {
                console.log('[v0] Tiempo agotado, aplicar decisi칩n por defecto (esperar)');
                makeDecision(false);
            }
        }
    }, 1000);
}

// Tomar decisi칩n
function makeDecision(buy) {
    if (!fomoGameState.gameActive) return;
    
    fomoGameState.gameActive = false;
    fomoGameState.userDecision = buy;
    clearInterval(fomoGameState.countdownTimer);
    
    console.log('[v0] Decisi칩n tomada:', buy ? 'COMPRAR' : 'ESPERAR');
    
    // Desactivar botones
    document.getElementById('buy-btn').disabled = true;
    document.getElementById('wait-btn').disabled = true;
    
    // Analizar resultado
    analyzeGameResult(buy);
}

// Analizar resultado
function analyzeGameResult(userBought) {
    // Usar datos del escenario si est치n disponibles
    let currentPrice, futureData, priceChange, minPrice, maxPrice, minChange;
    
    if (fomoGameState.scenario) {
        console.log('[v0] Usando datos del escenario');
        currentPrice = fomoGameState.scenario.currentPrice;
        futureData = fomoGameState.scenario.futureData;
        priceChange = fomoGameState.scenario.realOutcome;
        minPrice = currentPrice + (currentPrice * fomoGameState.scenario.worstOutcome / 100);
        maxPrice = currentPrice + (currentPrice * fomoGameState.scenario.bestOutcome / 100);
        minChange = fomoGameState.scenario.worstOutcome;
    } else {
        // Fallback a datos hist칩ricos
        const spikeIndex = fomoGameState.spikeIndex;
        const endIndex = Math.min(spikeIndex + 5, fomoGameState.data.length);
        futureData = fomoGameState.data.slice(spikeIndex + 1, endIndex);
        currentPrice = fomoGameState.data[fomoGameState.spikeIndex].close;
        const futurePrice = futureData[futureData.length - 1].close;
        priceChange = ((futurePrice - currentPrice) / currentPrice) * 100;
        minPrice = Math.min(...futureData.map(d => d.close));
        maxPrice = Math.max(...futureData.map(d => d.close));
        minChange = ((minPrice - currentPrice) / currentPrice) * 100;
    }
    
    console.log('[v0] Analizando resultado. Datos disponibles:', futureData.length, 'Precio actual: $' + currentPrice.toFixed(2), 'Cambio: ' + priceChange.toFixed(2) + '%');
    
    if (futureData.length === 0) {
        console.log('[v0] Error: Sin datos futuros para analizar');
        showNotification('Error: No hay datos despu칠s del pico para este an치lisis', 'error');
        document.getElementById('fomo-setup-section').style.display = 'block';
        document.getElementById('fomo-game-play').style.display = 'none';
        return;
    }
    
    // Determinar resultado
    let decision = '';
    let outcome = '';
    let isGoodDecision = false;
    let profitLoss = 0;
    
    if (userBought) {
        if (priceChange < 0) {
            decision = '仇 ENTRASTE POR FOMO';
            outcome = `El precio cay칩 ${Math.abs(priceChange).toFixed(2)}% en las siguientes horas.\n
                    <strong style="color: #ff6b6b;">Habr칤as perdido: ${Math.abs(priceChange).toFixed(2)}%</strong>\n
                    游늵 M칤nimo alcanzado: -${Math.abs(minChange).toFixed(2)}%`;
            isGoodDecision = false;
            profitLoss = -Math.abs(priceChange);
        } else {
            decision = '九 BUENA ENTRADA';
            outcome = `El precio subi칩 ${priceChange.toFixed(2)}% despu칠s.\n
                    <strong style="color: #00d084;">Ganancia: +${priceChange.toFixed(2)}%</strong>\n
                    游늳 M치ximo alcanzado: +${((maxPrice - currentPrice) / currentPrice * 100).toFixed(2)}%`;
            isGoodDecision = true;
            profitLoss = priceChange;
        }
    } else {
        if (priceChange < 0) {
            decision = '九 DECISI칍N CORRECTA';
            outcome = `El precio cay칩 ${Math.abs(priceChange).toFixed(2)}%.\n
                    <strong style="color: #00d084;">Evitaste una p칠rdida de: ${Math.abs(priceChange).toFixed(2)}%</strong>\n
                    游눠 La paciencia te salv칩`;
            isGoodDecision = true;
            profitLoss = 0;
        } else {
            decision = '丘멆잺 OPORTUNIDAD PERDIDA';
            outcome = `El precio subi칩 ${priceChange.toFixed(2)}% despu칠s.\n
                    <strong style="color: #ff9800;">No ganaste pero tampoco perdiste</strong>\n
                    游늳 M치ximo alcanzado: +${((maxPrice - currentPrice) / currentPrice * 100).toFixed(2)}%`;
            isGoodDecision = false;
            profitLoss = 0;
        }
    }
    
    // Mostrar resultados
    showGameResults(decision, outcome, isGoodDecision, profitLoss, priceChange);
}

// Mostrar resultados
function showGameResults(decision, outcome, isGood, profitLoss, realChange) {
    document.getElementById('fomo-game-play').style.display = 'none';
    document.getElementById('fomo-results').style.display = 'block';
    
    const resultsContent = document.getElementById('fomo-results-content');
    resultsContent.className = isGood ? 'fomo-feedback-positive' : 'fomo-feedback-negative';
    
    resultsContent.innerHTML = `
        <div style="margin-bottom: 1.5rem;">
            <h3 style="font-size: 1.5rem; margin-bottom: 1rem; color: ${isGood ? '#00d084' : '#ff6b6b'};">
                ${decision}
            </h3>
            <p style="color: var(--text-primary); line-height: 1.8; font-size: 1.05rem;">
                ${outcome}
            </p>
        </div>
        
        <div style="background: rgba(26, 31, 58, 0.3); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <h4 style="color: var(--secondary-color); margin-bottom: 1rem;">
                <i class="fas fa-graduation-cap"></i> Lecci칩n Educativa
            </h4>
            <ul style="list-style: none; padding: 0; color: var(--text-primary); line-height: 1.8;">
                ${getLessonPoints(fomoGameState.userDecision, realChange).map(point => 
                    `<li style="margin-bottom: 0.75rem;"><i class="fas fa-check" style="color: var(--secondary-color); margin-right: 0.5rem;"></i>${point}</li>`
                ).join('')}
            </ul>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div style="background: rgba(255, 197, 0, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                <p style="color: var(--text-secondary); font-size: 0.9rem;">Tu Decisi칩n</p>
                <p style="font-size: 1.3rem; font-weight: 700; color: var(--secondary-color);">
                    ${fomoGameState.userDecision ? 'COMPRAR' : 'ESPERAR'}
                </p>
            </div>
            <div style="background: rgba(0, 208, 132, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                <p style="color: var(--text-secondary); font-size: 0.9rem;">Lo Que Pas칩 Realmente</p>
                <p style="font-size: 1.3rem; font-weight: 700; color: ${realChange >= 0 ? '#00d084' : '#ff6b6b'};">
                    ${realChange >= 0 ? '+' : ''}${realChange.toFixed(2)}%
                </p>
            </div>
        </div>
    `;
}

// Obtener puntos de lecci칩n
function getLessonPoints(userBought, realChange) {
    const points = [];
    
    if (userBought && realChange < 0) {
        points.push('El FOMO (Fear Of Missing Out) es uno de los peores enemigos del trader.');
        points.push('Las subidas r치pidas sin confirmaci칩n t칠cnica suelen corregir fuerte.');
        points.push('Disciplina > Emoci칩n. Un no-trade es mejor que una mala operaci칩n.');
        points.push('Espera confirmaci칩n en volumen o indicadores antes de entrar.');
    } else if (userBought && realChange >= 0) {
        points.push('Esta vez tuviste suerte, pero el FOMO no es una estrategia.');
        points.push('No confundas ganar dinero por azar con ganar por estrategia.');
        points.push('Usa reglas de entrada claras, no impulsos emocionales.');
        points.push('A largo plazo, la disciplina vence al azar.');
    } else if (!userBought && realChange < 0) {
        points.push('Excelente: esperaste y evitaste una p칠rdida.');
        points.push('A veces el mejor trade es el que no haces.');
        points.push('Preserver capital es m치s importante que ganar en cada oportunidad.');
        points.push('La paciencia es una de las mejores cualidades de un trader exitoso.');
    } else {
        points.push('Evitaste el FOMO, pero se te escap칩 una ganancia esta vez.');
        points.push('No perder dinero NO es lo mismo que ganar dinero.');
        points.push('En trading, es mejor ser conservador que arruinarse.');
        points.push('Recuerda: siempre habr치 otra oportunidad.');
    }
    
    return points;
}

// Reiniciar juego
function resetFomoGame() {
    document.getElementById('fomo-setup-section').style.display = 'block';
    document.getElementById('fomo-game-play').style.display = 'none';
    document.getElementById('fomo-results').style.display = 'none';
    document.getElementById('fomo-cripto-select').value = '';
    fomoGameState = {
        cripto: null,
        data: [],
        spikeIndex: 0,
        userDecision: null,
        countdownTimer: null,
        timeRemaining: 10,
        gameActive: false
    };
}

</script>

</body>

</html>
